{% extends 'base.html' %}

{% block head_includes %}
{% load static %}
<script src="{% static 'graph/sigma.min.js' %}"></script>
<script src="{% static 'graph/sigma.layout.forceAtlas2.min.js' %}"></script>
<script src="{% static 'graph/sigma.plugins.filter.min.js' %}"></script>
<script src="{% static 'graph/sigma.renderers.edgeLabels.min.js' %}"></script>
<script src="{% static 'views/graph.js' %}"></script>
{% endblock head_includes %}

{% block content %}
{% csrf_token %}

<h3>Graph view</h3>
<p>
This is the highest level view of all match result views.
It shows a single graph of student pairs and the amount of high similarity submissions those pairs have.
Note that building the graph can take a considerable amount of time depending on server load and/or the amount of submissions to this course instance.
After the graph has been built, it will remain cached until new submissions are matched or the user manually invalidates the cache for this course instance.
</p>

<div class="graph-ui">
  <dl>
    <dt>Nodes</dt>
    <dd>Students, unique by student number</dd>
    <dt>Edges</dt>
    <dd>
    An edge between two nodes represents the existence of at least one pair of submissions that have a similarity higher than the specified minimum similarity.
    Edge weights represent the amount of such pairs.
    Click on an edge to open an overview of all matching pairs with maximum similarity.
    </dd>
  </dl>

  <div class="row">
      <div class="col-md-6 build-args-ui">
          <h4>Build parameters</h4>
          <div class="slidecontainer">
            <b>Minimum match similarity</b>
            <p>(pairs with similarity lower than {{ minimum_similarity_threshold }} are not stored)</p>
            <input type="range" class="slider" id="min-similarity-range" value="0.95" min="{{ minimum_similarity_threshold }}" max="1.00" step="0.01">
            <p id="min-similarity-range-value">0.95</p>
          </div>
          <button id="build-graph-button" type="button" class="btn btn-primary"
                  autocomplete="off">
            Build graph
          </button>
          <button id="invalidate-graph-button" type="button" class="btn btn-primary"
                  autocomplete="off">
            Remove this graph from the server cache
          </button>
      </div>

      <div class="col-md-6 filter-ui">
          <h4>Graph control</h4>
          <div class="slidecontainer">
            <b>Filter minimum match count</b>
            <input type="range" class="slider" id="min-match-count-range"
                   value="2" min="1" max="20" step="1">
            <p id="min-match-count-range-value">2</p>
          </div>
          <button id="refresh-graph-button" type="button" class="btn btn-primary"
                  aria-pressed="false" autocomplete="off">
            Refresh/apply
          </button>
          <button id="shuffle-layout-button" type="button" class="btn btn-primary"
                  aria-pressed="false" autocomplete="off">
            Shuffle graph layout
          </button>
      </div>
  </div>

  <div hidden id="load-progress" class="progress">
      <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
          <span class="loader-message"></span>
      </div>
  </div>
</div>

<div id="pair-comparisons-summary-modal" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>

<div id="graph-container"></div>

{% if graph.graph_json %}
<pre> {{ graph.graph_json|safe }} </pre>
<script>$(_ => drawGraphFromJSON('{{ graph.graph_json|safe }}'));</script>
{% else %}
<script>$(drawGraphAsync);</script>
{% endif %}

{% endblock %}
